<!-- ...existing code... -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Horas</title>
    <style>
        /* ...existing code... */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 90vh;
            padding: 20px;
            background: linear-gradient(to right, #330033, #220427);
            box-sizing: border-box;
        }

        .container {
            width: 80%;
            max-width: 600px;
            padding: 10px;
            box-sizing: border-box;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background-color: rgba(211, 211, 211, 0.9);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            height: auto;
        }

        .bloque {
            margin-bottom: 10px;
        }

        label {
            display: block;
            text-align: center;
            margin-bottom: 8px;
            color: #000;
            font-weight: 600;
        }

        select,
        input[type="text"],
        input[type="time"] {
            width: 200px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            font-size: 16px;
            color: #000;
            transition: border-color 0.3s ease;
        }

        select:focus,
        input[type="text"]:focus,
        input[type="time"]:focus {
            border-color: #6a82ab;
            outline: none;
        }

        input[type="text"][readonly] {
            background-color: #eee;
            color: #000;
            cursor: not-allowed;
        }

        /* Estilo específico para el campo "Me Despierto" */
        #meDespierto {
            background-color: #a8e4a0; /* Un verde claro */
        }

        h1 {
            color: #000;
            margin-bottom: 5px;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Botones añadidos */
        .botones {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(90deg,#6a82ab,#3b3f7a);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .btn.secondary {
            background: linear-gradient(90deg,#3b7a3b,#6aa86a);
        }

        /* Preview overlay (discreto, sin pop-ups) */
        #previewOverlay {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
            background: rgba(0,0,0,0.6);
            padding: 12px;
            border-radius: 8px;
            max-width: 95%;
            max-height: 90%;
            box-sizing: border-box;
        }
        #previewBox {
            background: #fff;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            max-height: calc(90vh - 40px);
            overflow: auto;
        }
        #previewBox img {
            display: block;
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        #previewActions {
            margin-top: 8px;
            display:flex;
            gap:8px;
            justify-content:center;
        }
        .tiny-btn {
            padding:6px 10px;
            border-radius:6px;
            border:none;
            cursor:pointer;
            font-weight:600;
            color:#fff;
            background:linear-gradient(90deg,#6a82ab,#3b3f7a);
        }
        .tiny-btn.secondary { background:linear-gradient(90deg,#3b7a3b,#6aa86a); }
    </style>
</head>
<body>
    <div class="container">
        <h1>Horario Feria</h1>

        <div class="bloque">
            <label for="inicioFeria">Inicio de Feria:</label>
            <input type="time" id="inicioFeria" value="08:00">
        </div>

        <div class="bloque">
            <label for="llegadaColegio">Llegada al Colegio:</label>
            <input type="text" id="llegadaColegio" readonly>
        </div>

        <div class="bloque">
            <label for="salirViarTiempo">T. Trayecto</label>
            <select id="salirViarTiempo">
                <option value="5">5 m</option>
                <option value="10">10 m</option>
                <option value="15">15 m</option>
                <option value="20">20 m</option>
                <option value="25">25 m</option>
                <option value="30">30 m</option>
                <option value="35">35 m</option>
                <option value="40">40 m</option>
                <option value="45">45 m</option>
                <option value="50">50 m</option>
                <option value="55">55 m</option>
                <option value="60">1 h</option>
                <option value="65">1 h 5 m</option>
                <option value="70">1 h 10 m</option>
                <option value="75">1 h 15 m</option>
                <option value="80">1 h 20 m</option>
                <option value="85">1 h 25 m</option>
                <option value="90">1 h 30 m</option>
                <option value="95">1 h 35 m</option>
                <option value="100">1 h 40 m</option>
                <option value="105">1 h 45 m</option>
                <option value="110">1 h 50 m</option>
                <option value="115">1 h 55 m</option>
                <option value="120">2 h</option>
                <option value="125">2 h 5 m</option>
                <option value="130">2 h 10 m</option>
                <option value="135">2 h 15 m</option>
                <option value="140">2 h 20 m</option>
                <option value="145">2 h 25 m</option>
                <option value="150">2 h 30 m</option>
                <option value="155">2 h 35 m</option>
                <option value="160">2 h 40 m</option>
                <option value="165">2 h 45 m</option>
                <option value="170">2 h 50 m</option>
                <option value="175">2 h 55 m</option>
                <option value="180">3 h</option>
            </select>
        </div>

        <div class="bloque">
            <label for="salirViarResultado">Salir de Biar:</label>
            <input type="text" id="salirViarResultado" readonly>
        </div>

        <div class="bloque">
            <label for="meDespierto">Me Despierto:</label>
            <input type="text" id="meDespierto" readonly>
        </div>

        <!-- Botones añadidos -->
        <div class="botones">
            <button id="btnCaptura" class="btn" title="Capturar la sección">Capturar pantalla</button>
            <button id="btnCopiarWhatsApp" class="btn secondary" title="Copiar texto formateado">Copiar para WhatsApp</button>
        </div>
    </div>

    <!-- Preview discreto para la captura (sin pop-ups) -->
    <div id="previewOverlay" aria-hidden="true">
        <div id="previewBox">
            <img id="previewImg" alt="Captura">
            <div id="previewActions">
                <button id="btnGuardar" class="tiny-btn secondary">Guardar</button>
                <button id="btnCerrarPreview" class="tiny-btn">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        /* ...existing code... */
        function calcularHoras() {
            let inicioFeria = document.getElementById("inicioFeria").value;
            let inicioFeriaHora = parseInt  (inicioFeria.split(":")[0] || "0");
            let inicioFeriaMinuto = parseInt(inicioFeria.split(":")[1] || "0");

            // Calcular llegada al colegio (1 hora antes del inicio de feria)
            let llegadaColegioHora = inicioFeriaHora - 1;
            let llegadaColegio = (llegadaColegioHora < 10 ? "0" : "") + llegadaColegioHora + ":" + 
                                (inicioFeriaMinuto < 10 ? "0" : "") + inicioFeriaMinuto;
            document.getElementById("llegadaColegio").value = llegadaColegio;

            // Tiempo de trayecto seleccionado
            let salirViarTiempo = parseInt(document.getElementById("salirViarTiempo").value);

            // Convertir llegada al colegio a minutos totales
            let llegadaColegioHoraSalir = parseInt(llegadaColegio.split(":")[0]);
            let llegadaColegioMinutoSalir = parseInt(llegadaColegio.split(":")[1]);
            let salirViarMinutosTotales = llegadaColegioHoraSalir * 60 + llegadaColegioMinutoSalir - salirViarTiempo;

            // Convertir a hora y minutos
            let salirViarHora = Math.floor(salirViarMinutosTotales / 60);
            let salirViarMinuto = salirViarMinutosTotales % 60;
            let salirViar = (salirViarHora < 10 ? "0" : "") + salirViarHora + ":" + 
                           (salirViarMinuto < 10 ? "0" : "") + salirViarMinuto;
            document.getElementById("salirViarResultado").value = salirViar;

            // Calcular hora de despertarse (1 hora antes de salir de Biar)
            let salirViarHoraDespierto = parseInt(salirViar.split(":")[0]);
            let salirViarMinutoDespierto = parseInt(salirViar.split(":")[1]);
            let meDespiertoMinutosTotales = salirViarHoraDespierto * 60 + salirViarMinutoDespierto - 60;

            let meDespiertoHora = Math.floor(meDespiertoMinutosTotales / 60);
            let meDespiertoMinuto = meDespiertoMinutosTotales % 60;

            // Ajustar si es antes de medianoche
            if (meDespiertoHora < 0) {
                meDespiertoHora += 24;
            }

            let meDespierto = (meDespiertoHora < 10 ? "0" : "") + meDespiertoHora + ":" + 
                             (meDespiertoMinuto < 10 ? "0" : "") + meDespiertoMinuto;
            document.getElementById("meDespierto").value = meDespierto;
        }

        // Ejecutar al cambiar cualquier campo
        document.getElementById("inicioFeria").addEventListener("change", calcularHoras);
        document.getElementById("salirViarTiempo").addEventListener("change", calcularHoras);

        // Calcular al cargar la página
        calcularHoras();
    </script>

    <!-- Cargar html2canvas desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Nueva función de captura: no muestra alerts, deja la imagen en vista previa y ofrece "Guardar"
        // Ahora recorta JUSTO DEBAJO del bloque "Salir de Biar" (salirViarResultado)
        async function capturarPantalla() {
            const target = document.querySelector('.container');
            const salirEl = document.getElementById('salirViarResultado');
            const previewOverlay = document.getElementById('previewOverlay');
            const previewImg = document.getElementById('previewImg');
            const btnGuardar = document.getElementById('btnGuardar');

            if (!target) return; // silencioso si falta objetivo

            try {
                // Renderizar la sección completa a canvas
                const canvas = await html2canvas(target, {useCORS: true, scale: 2});

                // Preparar recorte POR ABAJO: recortar hasta justo DEBAJO del bloque "Salir de Biar"
                let finalCanvas = canvas;
                if (salirEl) {
                    const containerRect = target.getBoundingClientRect();
                    const salirRect = salirEl.getBoundingClientRect();
                    const scale = canvas.width / containerRect.width;

                    // calculamos la Y (en px del canvas) donde termina el elemento "salirViarResultado"
                    // usamos salirRect.bottom (parte inferior del input) relativa al container
                    const salirBottomOnCanvas = Math.round((salirRect.bottom - containerRect.top) * scale);

                    // margen extra abajo para incluir todo el input y algo de espacio visual
                    const marginBelowPx = Math.round(8 * scale);

                    // Altura final: desde 0 hasta salirBottomOnCanvas + marginBelowPx
                    let sHeight = salirBottomOnCanvas + marginBelowPx;

                    // Asegurar límites válidos
                    if (sHeight <= 10 || sHeight > canvas.height) {
                        // si queda demasiado pequeño o mayor que el canvas, usar canvas completo
                        sHeight = canvas.height;
                    }

                    if (sHeight < canvas.height) {
                        const newCanvas = document.createElement('canvas');
                        newCanvas.width = canvas.width;
                        newCanvas.height = sHeight;
                        const ctx = newCanvas.getContext('2d');
                        // dibujar la parte superior desde 0 hasta sHeight (no se toca la parte superior)
                        ctx.drawImage(canvas, 0, 0, canvas.width, sHeight, 0, 0, canvas.width, sHeight);
                        finalCanvas = newCanvas;
                    }
                }

                // Crear blob y objeto URL para mostrar en la vista previa
                const blob = await new Promise(resolve => finalCanvas.toBlob(resolve, 'image/png'));
                if (!blob) return; // silencioso en fallo

                const url = URL.createObjectURL(blob);
                previewImg.src = url;

                // Mostrar overlay (sin pop-ups)
                previewOverlay.style.display = 'block';
                previewOverlay.setAttribute('aria-hidden', 'false');

                // Preparar botón Guardar (descarga bajo demanda)
                btnGuardar.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'captura.png';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                };

                // Intento silencioso de copiar imagen al portapapeles (si el navegador lo permite)
                if (navigator.clipboard && window.ClipboardItem) {
                    blob.arrayBuffer().then(buffer => {
                        const clipboardItemInput = new ClipboardItem({ 'image/png': new Blob([buffer], {type: 'image/png'}) });
                        navigator.clipboard.write([clipboardItemInput]).catch(() => {
                            // en caso de fallo, no hacer nada (sin avisos)
                        });
                    }).catch(()=>{});
                }

                // Nota: no hay alerts ni prompts; la imagen queda visible hasta que cierres preview.
            } catch (err) {
                // silencioso: no mostrar alert; simplemente no hacer nada si falla
                return;
            }
        }

        function copiarParaWhatsApp() {
            const inicio = document.getElementById('inicioFeria').value || '';
            const llegada = document.getElementById('llegadaColegio').value || '';
            const trayectoText = (document.getElementById('salirViarTiempo').selectedOptions[0] || {}).text || '';
            const salir = document.getElementById('salirViarResultado').value || '';
            const despierto = document.getElementById('meDespierto').value || '';

            const texto =
`Horario Feria
Inicio: ${inicio}
Llegada al colegio: ${llegada}
Tiempo trayecto: ${trayectoText}
Salir de Biar: ${salir}
Me despierto: ${despierto}`;

            // Copiar texto silenciosamente; si falla, no mostrar alert
            navigator.clipboard && navigator.clipboard.writeText(texto).catch(()=>{});
            // Abrir WhatsApp Web en nueva pestaña (no intrusivo)
            const wa = 'https://wa.me/?text=' + encodeURIComponent(texto);
            window.open(wa, '_blank');
        }

        // Cerrar preview discreto
        document.getElementById('btnCerrarPreview').addEventListener('click', () => {
            const previewOverlay = document.getElementById('previewOverlay');
            const previewImg = document.getElementById('previewImg');
            // liberar recurso
            if (previewImg && previewImg.src) {
                URL.revokeObjectURL(previewImg.src);
                previewImg.src = '';
            }
            previewOverlay.style.display = 'none';
            previewOverlay.setAttribute('aria-hidden', 'true');
        });

        document.getElementById('btnCaptura').addEventListener('click', capturarPantalla);
        document.getElementById('btnCopiarWhatsApp').addEventListener('click', copiarParaWhatsApp);
    </script>
</body>
</html>
<!-- ...existing code... -->